Bootstrap: docker
From: continuumio/miniconda3:23.5.2-0

%labels
    Author YourName
    Description "Miniconda base + samtools/bcftools (source) + plink2 + Java"

%environment
    export PATH="/opt/conda/bin:/opt/htslib/bin:/opt/samtools/bin:/opt/bcftools/bin:/opt/plink2:$PATH"
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8

%post
    set -eux

    ############################################################
    # Install system dependencies
    ############################################################
    apt-get update
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        default-jre \
        default-jdk \
        build-essential \
        wget curl unzip bzip2 gzip \
        libbz2-dev liblzma-dev libz-dev \
        libssl-dev libffi-dev \
        libncurses5-dev libncursesw5-dev \
        libreadline-dev libsqlite3-dev libgdbm-dev \
        libgd-dev \
        ca-certificates \
        git \
        less vim \
    && rm -rf /var/lib/apt/lists/*

    ############################################################
    # Install PLINK2
    ############################################################
    mkdir -p /opt/plink2
    cd /opt/plink2

    wget https://s3.amazonaws.com/plink2-assets/alpha6/plink2_linux_avx2_20251026.zip -O plink2.zip
    unzip plink2.zip
    rm plink2.zip

    chmod +x plink2
    ln -s /opt/plink2/plink2 /usr/local/bin/plink2
    
   ###########################################################
   # Install bcftools
   ###########################################################
   mkdir -p /opt/bcftools
   cd /opt/bcftools
   wget https://github.com/samtools/bcftools/releases/download/1.22/bcftools-1.22.tar.bz2
   tar -xvf bcftools-1.22.tar.bz2
   cd bcftools-1.22
   ./configure --disable-libcurl --disable-ref-cache --prefix=/opt/bcftools/bcftools-1.22/
   make
   make install
   chmod +x bcftools
   ln -s /opt/bcftools/bcftools-1.22/bcftools /usr/local/bin/bcftools

  ############################################################
  # Install ArgWeaver
  ############################################################
  mkdir -p /opt/argweaver
  cd /opt/argweaver
  wget https://github.com/mdrasmus/argweaver/zipball/master
  unzip master
  cd mdrasmus-argweaver-fee3d32
  make
  ln -s /opt/argweaver/mdrasmus-argweaver-fee3d32/bin/arg-sample /usr/local/bin/arg-sample
  ln -s /opt/argweaver/mdrasmus-argweaver-fee3d32/bin/arg-summarize /usr/local/bin/arg-summarize
  ln -s /opt/argweaver/mdrasmus-argweaver-fee3d32/bin/smc2bed /usr/local/bin/smc2bed
  
  
  ############################################################
  # Install Singer
  ###########################################################
  mkdir -p /opt/singer
  cd /opt/singer
  git clone https://github.com/argsortium/SINGER.git
  
  ln -s /opt/singer/SINGER/SINGER/SINGER/singer_master /usr/local/bin/singer_master

  ##########################################################
  #Relate #FIXME
  ##########################################################
  mkdir -p /opt/relate
  cd /opt/relate
  #git clone https://github.com/MyersGroup/relate.git
  
  #mv relate/old_versions/relate_v1.2.4_x86_64_static.tgz .
  #tar -xvf relate_v1.2.4_x86_64_static.tgz
  
  #rm -rf relate
  #########################################################
  #Tsinfer + tsdate
  ########################################################
  /opt/conda/bin/python -m pip install tsinfer tsdate zarr==2.18.4

  #######################################################
  #ArgNeedle
  #######################################################
  /opt/conda/bin/python -m pip install arg-needle

  #######################################################
  #Python Packages
  #######################################################
  /opt/conda/bin/conda install -y numpy pandas

%runscript
    echo "ARG inference environment loaded."
    exec /bin/bash "$@"

